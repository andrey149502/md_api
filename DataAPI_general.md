# Data API v2.x

**Change History**

Version | Date | Comment
:------ | :--- | :------
[Current Version (v. 278)](https://doc.dev.uiscom.ru/display/projects/viewpage.action?pageId=19103909) | May 31, 2017 15:25 | Ивченко Максим
[v. 277](https://doc.dev.uiscom.ru/display/projects/viewpage.action?pageId=39817995) | May 23, 2017 14:18 | Ивченко Максим
[v. 276](https://doc.dev.uiscom.ru/display/projects/viewpage.action?pageId=39816579) | May 23, 2017 14:17 | Ивченко Максим

**Contributors**

[Ивченко Максим](https://doc.dev.uiscom.ru/display/~ivchenko) 272 (14 days ago), [Белобородов Дмитрий](https://doc.dev.uiscom.ru/display/~beloborodov) 1 (372 days ago), [Васильев Святослав](https://doc.dev.uiscom.ru/display/~vasiliev) 5 (503 days ago)

**Watchers**

[Бочаров Василий](https://doc.dev.uiscom.ru/display/~bocharov), [Бродский Илья](https://doc.dev.uiscom.ru/display/~brodskiy), [Васильев Святослав](https://doc.dev.uiscom.ru/display/~vasiliev), [Вязовцев Денис](https://doc.dev.uiscom.ru/display/~vyazovtsev), [Гогов Станислав](https://doc.dev.uiscom.ru/display/~gogov), [Гузикова Анастасия](https://doc.dev.uiscom.ru/display/~guzikova), [Дешевых Степан](https://doc.dev.uiscom.ru/display/~deshevyh), [Дмитриев Илья](https://doc.dev.uiscom.ru/display/~dmitriev), [Ефимова Мария](https://doc.dev.uiscom.ru/display/~efimova), [Ивченко Максим](https://doc.dev.uiscom.ru/display/~ivchenko), [Кисляков Дмитрий](https://doc.dev.uiscom.ru/display/~kislyakov), [Кузнецов Игорь](https://doc.dev.uiscom.ru/display/~ikuznetsov), [Лысогорский Дмитрий](https://doc.dev.uiscom.ru/display/~lysogorskii), [Нехорошев Артем](https://doc.dev.uiscom.ru/display/~nekhoroshev), [Павлова Ольга](https://doc.dev.uiscom.ru/display/~borisova), [Пащенко Валерий](https://doc.dev.uiscom.ru/display/~pashchenko), [Семенов Михаил](https://doc.dev.uiscom.ru/display/~semenov), [Серебряков Павел](https://doc.dev.uiscom.ru/display/~serebryakov), [Сидоров Никита](https://doc.dev.uiscom.ru/display/~sidorov), [Спасский Павел](https://doc.dev.uiscom.ru/display/~spasskij), [Сычугов Антон](https://doc.dev.uiscom.ru/display/~sychugov), [Хлебущев Александр](https://doc.dev.uiscom.ru/display/~khlebushchev), [Черняков Андрей](https://doc.dev.uiscom.ru/display/~chernyakov), [Юрченко Надежда](https://doc.dev.uiscom.ru/display/~hr_uis)

## Важные проблемы

`P1` На текущий момент таймаут на выполнение запроса в БД = 240 секунд. На уровне Nginx = 300 секунд. По
истечение времени ожидания (таймаута) ответа от БД запрос заканчивается с ошибкой `request_timeout`. В результате этого
следующий запрос к БД падает с проблемой, которая описана в задаче [ARCH-32](https://tr.dev.uiscom.ru/browse/ARCH-32) 

Возможное решение предлагалось в задаче [INT-1778](https://tr.dev.uiscom.ru/browse/INT-1778) но оно не сработало.
Проблема осталась.

Для того чтобы понять сколько таких запросов, нужно сделать grep по логам Data API сервера. Строка поиска
`"api.jsonrpc.errors.RequestTimeoutError"`

## Общая информация

Настоящий документ описывает Data API, которое позволяет получать/добавлять/удалять/редактировать сущностинеобходимые для работы сервисов CoMagic и UIS. API реализован на основе спецификации [JSON-RPC 2.0](http://www.jsonrpc.org/specification) без поддержкигрупповых операций. При запросах к API в качестве транспортного протокола используется [HTTP/1.1](http://tools.ietf.org/html/rfc2616) с защитой соединения спомощью SSL/TLS, при этом соблюдая следующие требования:

* Заголовок Content-Type должен быть `"application/json; charset=UTF-8"`
* Заголовок Content-Length должен содержать корректную длину сообщения, следуя спецификации [HTTP/1.1](http://tools.ietf.org/html/rfc2616)

> На функциональность не должно влиять, т.е это касается только уровня транспорта. Мы договорились, что не привязываемся в части функционала к конкретному транспорту. Т.е клиент не должен передавать указанные заголовки.

## Важные замечания

> При каждом вызове метода API необходимо проверять, что компонент API активен в профиле аккаунта клиента (см. [Биллинг](#))

> Должна быть проверка на статус клиента. Для неактивного клиента доступ к API должен быть запрещён

> Проверять ограничения тарифного плана, т.е многие методы могут быть недоступны так как не подключены соответствующие компоненты.
> Для каждого метода нужно проверять, что подключён соответствующий компонент

> В Redis должно быть отдельное пространство для API, т.е все данные которые связаны с API должны храниться с префиксом, к примеру `rpc_api`

> Ограничиваем размер JSON'а 100Kb + код ошибки из HTTP 413

> Проверять принадлежность виртуального номера клиенту

> При отключении компонента `"dataapi"` (см. [Биллинг](#)) у всех пользователей и ключей должен быть удален доступ к Data API

> Возможно использовать `fail2ban`
> Добавляем в вывод в лог следующих событий:
> * IP адрес не находится в белом списке
> * Логин/Пароль указан неверно
> * Ключ доступа не найден, т.е пришли с постоянным ключом, а он неактивен или просто такого не существует
> * Версия не найдена, т.е пришли на ошибочный URL
> Сообщение об ошибке обязательно должно содержать в себе:
> * IP источника запроса
> * Дата и время запроса
> * Сообщение об ошибке

## Соглашения

Приняты следующие соглашения при использовании API:

* Пустые поля всегда возвращаются в ответе со значением `null`. В случае массива возвращается пустой массив, в случае объекта возвращается пустой объект;
* Все поля связанные с датой и временем передаются согласно ISO 8601 в формате YYYY-MM-DDT hh:mm:ssZ;
* Запросы к API выполняются всегда с помощью метода POST;
* Все параметры в запросах/ответах, а также в структурах данных в формате JSON и название методов именуются в стиле Snake Case - разделение слов через нижнее подчёркивание;
* Данные возвращаются только в JSON формате согласно спецификации [RFC 7159](https://tools.ietf.org/html/rfc7159);
* Кодировка данных UTF-8;

## Формат возвращаемых данных

**Таблица 1. Поддерживаемые форматы возвращаемых данных**

Формат | MIME Type
:----- | :--------
JSON | application/json

> По умолчанию используется формат JSON. Заголовок Accept игнорируется

## Базовый URL для доступа к API

Базовый для доступа к URI API соответствует следующему шаблону:

```
<protocol> :// <hostname> / <version>
```

* `<protocol>` - https;
* `<hostname>` - FQDN;
* `<version>` - версия API (см. раздел [Версионность](#))

> API должен быть доступен по следующим URL:  
> Клиентское API: https://api.uiscom.ru/<version> и https://api.comagic.ru/<version>

## Версионность

Data API поддерживает версионность. Версия указывается в базовом URL как `vX.Y`, где `X` - номер мажорной версии, `Y` - номер минорной версии

> Версия может указываться через точку, т.е может быть к примеру `2.1`

> Если была выпущена новая версия, то старая считается устаревшей и соответственно при обращении к старой версии API в мета-параметрах (см. раздел [Мета-парамметры](#)) будет возвращаться параметр `"current_version_deprecated"` со значением `"true"`

Пример:  
http://api.uiscom.ru/v4.0  
http://api.comagic.ru/v4.0

> Максимальное количество поддерживаемых версий - 2  
> Период поддержки устаревшей версии 2 месяца

## Лимиты и ограничения

> Балы списываются только за успешные запросы, т.е в отчете по запросам он помечен как успешный. Успешным считается запрос, если в `"result"` был возвращен статус `"success" = true` или идентификатор сессии звонка

> Лимиты привязаны к базовому компоненту `"dataapi"` (см. [Биллинг](#)) и учитываются в зависимости от веса метода  
> Информация о лимитах возвращается во всех ответах в мета-парметрах (см. [Мета-параметры](#)) кроме случаев когда лимиты не учитываются;

Лимиты построены по бальной системе, т.е каждый метод имеет свой вес. Вызов метода уменьшает доступные

дневные/минутные балы на размер веса вызываемого метода
Лимиты возвращаются на каждый успешный/ошибочный ответ в мета-параметрах, см. раздел "[Мета-параметры](#)"

**Таблица 3. Возвращаемые параметры**

Название параметра | Описание
:----------------- | :-------
`day_limit` | Текущие лимит запросов в день
`day_remaining` | Какое количество запросов осталось до достижения дневного лимита
`day_reset` | Время в секундах через которое дневной лимит будет сброшен
`minute_limit` | Текущие лимит запросов за минуту
`minute_remaining` | Какое количество запросов осталось до достижения минутного лимита
`minute_reset` | Время в секундах через которое минутный лимит будет сброшен

### Расширение лимитов

На страницу "Аккаунт" -> "Тарифы и опции" добавить возможность покупки компонентов (см. Биллинг) и расширения лимитов.

Название лимитов:
* `max_minute_dataapi_point` - Балов Data API в минуту;
* `max_day_dataapi_point` - Балов Data API в день

Максимальное значение для расширения лимитов:
* Количество балов в минуту - максимальное значение `ЗАПРОСИТЬ У СЛАВЫ` ;
* Количество балов в день - максимальное значение `ЗАПРОСИТЬ У СЛАВЫ` ;


## Обработка ошибок

> Предлагается вести конфигурационный файл, который содержит маппинг мнемокода ошибки `"mnemocode"` с параметром `"extended_helper"`

### Параметры сообщения об ошибке

Название | Тип  | Обязательный | Допустимые значения | Описание
:------- | :--- | :----------: | :------------------ | :-------
`error` | object | да |  | Объект с содержимым ошибки
`code` | number | да |  | Код ошибки (см. раздел [Коды ошибок](#) )
`message` | string | да |  | Cообщение об ошибке (см. раздел [Коды ошибок](#) ) <blockquote>В тексте сообщения возможно использовать параметры замены: <br>`{field}`, `{value}`, параметры из поля `"params"` `{'name1': 'value1', 'name2': 'value2', ...}`, при форматировании эти параметры должны быть названы `{name1}`, `{name2}` и т.д., и вместо них подставляются соответствующие значения</blockquote>
`data` | object | да |  | Объект с деталями ошибки
`mnemonic` | string | да |  | Уникальный текстовый код ошибки
`value` | string | нет |  | Содержит то, что передал пользователь без изменений <blockquote>В некоторых случаях может отсутствовать. К примеру, обязательный параметр вообще не был заполнен.</blockquote>
`extended_helper` | string | нет |  | Ссылка на более подробное описание ошибки и возможные решения
`params` | object | нет |  | Карта подстановок параметров для шаблона с текстом об ошибке. Т.е. содержит динамически изменяемые значения, к примеру, лимиты. Значения указанные в этом параметре могут быть использованы в сообщениях об ошибках в интерфейсе над Call API (рабочее место оператора).
`field` | string | нет |  | Название параметра, с которым связана ошибка <blockquote>Вложенные параметры отображаем через разделитель точка "."<br>К примеру: `"employee.phone_number"`</blockquote><blockquote>Необходимо всегда заполнять, так как мы всегда знаем ошибочный параметр</blockquote>

### JSON структура ошибки

```json
{
  "jsonrpc":"2.0",
  "id":null,
  "error":{
    "code":"number",
    "message":"string",
    "data":{
      "mnemonic":"string",
      "field":"string",
      "value":"string",
      "params":{
        "object":"string"
      },
      "extended_helper":"string"
    }
  }
}
```

### Группы кодов ошибок

Код ошибки | Описание
---------- | --------
`-32700` | Ошибки связанные с валидацией JSON
`-32600` | Ошибки связанные с валидацией параметров запроса - `id`, `jsonrpc`
`-32601` | Ошибки связанные с методом
`-32602` | Ошибки связанные с валидацией параметров в вызываемом методе
`-32603` | Внутренние ошибки JSON RPC сервера
`-32001` | Ошибки аутентификации и ошибки с ключами
`-32002` | Ошибки связанные с: правила безопасности запрещают звонок по указанному направлению (см. раздел [Правила безопасности](#)) и черным списком
`-32003` | Ошибки с правами доступа - ip адрес не в белом списке, нет прав у пользователя
`-32004` | Ошибки связанные с неверной последовательностью вызываемых методов
`-32007` | Ошибки связанные с виртуальным номером
`-32008` | Ошибки связанные с компонентами
`-32009` | Ошибки связанные с аккаунтом заказчика
`-32029` | Ошибки связанные с лимитами
`-32099` | Ошибки связанные с поддержкой различных частей спецификации JSON RPC 2.0 - Групповые операции, Уведомления

### Список ошибок общих для всех методов

Текст сообщение | Код | Мнемоника | Описание
--------------- | --- | --------- | --------
*Invalid Request The JSON sent is not a valid Request object* | `-32600` |  `invalid_request` | Ошибки связанные с валидацией параметров запроса - `id`, `jsonrpc`
*Access token has been expired* | `-32001` | `access_token_expired` |  Применяется только к постоянному токену. Если время жизни постоянного токена истекло, то возвращается указанная ошибка
*Access token has been blocked* | `-32001` | `access_token_blocked` | Если постоянный токен заблокирован, то возвращается указанная ошибка
*Access token is invalid* | `-32001` | `access_token_invalid` | Указанная ошибка возвращается если постоянный/временный токен не найден
*Limit per `{limit_type}` has been exceeded. Value of current limit per `{limit_type}` is `{limit_max_value}`* | `-32029` | `limit_exceeded` | 
*You need at least on of the following components to access this method: `{components}`* | `-32008` | `method_component_disabled` | Если у клиента не подключен компонент, который требуется для работы метода
*You need at least on of the following components to access this paremeter: `{components}`* | `-32008` | `parameter_component_disabled` | Если у клиента не подключен компонент, который нужен для заполнения параметра и создания сущности
*Your IP `{ip}` is not whitelisted* | `-32003` | `ip_not_whitelisted` |  
*Login or password is wrong* | `-32001` | `auth_error` |
*Your account has been disabled, contact the support service* | `-32009` | `account_inactive` | Аккаунт `app_id` заблокирован
*Internal error, contact the support service* | `-32603` | `internal_error` | 
*Data supplied is of wrong type* | `-32602` | `data_type_error` | К примеру, если ожидаем string а передали int
*The method does not exist / is not available* | `-32601` | `method_not_found` |
*Permission denied* | `-32003` | `forbidden` | Нет прав на доступ к методу или API, или запрещено выполнять какое-либо действие
*Invalid JSON was received by the server.* | `-32700` `parse_error` |
*Batch operations not supported* | `-32099` | `batch_opreations_not_supported` | 
*Notifications not supported* | `-32099` | `notifications_not_supported` |
*The required parameter has been missed* | `-32602` | `required_parameter_missed` | Обязательный параметр не передали
*Invalid parameter value* | `-32602` | `invalid_parameter_value` | Возвращается во всех случаях, если было передано некорректное значение параметра или переданное значение не соответствует требуемому формату ввода
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Если в `"params"` были переданы параметры которые не предусмотрены JSON структурой метода или указан параметр для сортировки, фильтрации и выборки, который не существует
*The combination of parameters is not permitted* | `-32602` | `invalid_parameters_combination` | Если параметры указанные в методе находятся в недопустимой комбинации. Нужно смотреть документацию по методу и его параметрам.
*`{error_message}`* | `-32602` | `error` | Договорились о следующем: <br> В БД могут возникнуть Exceptions или SMART ERROR и стараемся при получении такой ошибки на стороне БД замапить в существующие мнемоники, если они не мапятся, то возвращаем ошибку `"error"` и уже в нее передаем текст ошибки из БД, но важно исключить слово `"SMART ERROR"` и текста ошибки

### Список ошибок для методов с глаголом get

> Возможны ошибки, которые находятся в разделе ["Список ошибок общих для всех методов"](#)

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Invalid parameter value* | `-32602` | `invalid_parameter_value` | Если в фильтрах было передано некорректное значение для regexp, jsquery и ли любых значений не соответствующих документации
*Sort by parameter is prohibited* | `-32602` | `sort_prohibited` | Сортировка по параметру запрещена и невозможна, так как параметр для сортировки не находится в списке разрешенных для сортировки
*Filter by parameter is prohibited* | `-32602` | `filter_prohibited` | Фильтрация по параметру запрещена и невозможна, так как параметр для фильтрации не находится в списке разрешенных для фильтрации
*Data supplied is of wrong type* | `-32602` | `data_type_error` | К примеру, если ожидаем string а передали int
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Если в `"params"` были переданы параметры которые не предусмотрены JSON структурой метода или указан параметр для сортировки, фильтрации и выборки, который не существуе
*Max value of requested date interval is 3 months* | `-32602` | `date_interval_limit_reached` | Если в запросе период между указанными датами в `date_from` и `date_till` превышает 3 месяца. В основном ошибка актуальна только для методов получения отчетов, но не для всех.

### Список ошибок общих для методов с глаголом delete

> Возможны ошибки, которые находятся в разделе ["Список ошибок общих для всех методов"](#)

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Entity not found* | `-32602` | `entity_not_found` | Если передан уникальный идентификатор сущности, которая не найдена у `app_id`
*The required parameter has been missed* | `-32602` | `required_parameter_missed` | Обязательный параметр не передали
*You have interdependet entities* | `-32602` | `dependency_error` | Удаляемая сущность используется в других сущностях. Чтобы удалить, необходимо убрать удаляемую сущность из всех возможных настроек
*Permission denied* | `-32602` | `forbidden` | Удалить сущность невозможно так как она системная, к примеру группа "Черный список" в адресной книге

### Список ошибок общих для методов с глаголом create и update, set, unset

> Возможны ошибки, которые находятся в разделе ["Список ошибок общих для всех методов"](#)

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Entity not found* | `-32602` | `entity_not_found` | Если передан уникальный идентификатор сущности, которая не найдена у `app_id`
*Duplicate entity* | `-32602` | `duplicate_entity` | Если сущность уже существует в рамках `app_id`
*The required parameter has been missed* | `-32602` | `required_parameter_missed` | Обязательный параметр не передали
*Unexpected method parameter(s)* | `-32602` | `invalid_parameter_value` | Если в `"params"` были переданы параметры которые не предусмотрены JSON структурой метода или указаны значения не соответствующие допустимым значениям
*A new data limit has been exceeded* | `-32602` | `data_limit_exceeded` | Ошибка возникает в случае, если у клиента было достигнуто максимальное количество данных в таблицах конфигурации сервиса. количество данных определяется количеством строк и принятое ограничение установлено в 100 000 строк
*Добавляю ошибку `tariff_restrictions` `-32602` Action is not allowed for your tariff plan. You need contact support service or change your tariff plan settings in your account. Когда возникают ограничения тарифного плана* | `-32602` | `tariff_restrictions` | Любые ограничения тарифного плана

## Поддержка языковых схем

Функционал не поддерживается

## Групповые операции

Функционал не поддерживается

## Принцип именования методов

Имя JSON-RPC метода состоит из двух частей разделенных точкой: глагола и имени объекта. Глаголы соответствуют концепции CRUD.

Имя объекта выбирается как существительное во множественном числе, отражающее бизнес-сущность, например `subscribers`.

Имя метода должно начинаться с глагола, отражающего суть операции.

### Глаголы используемые в именовании методов

**Таблица 5. Глаголы используемые в именовании методов**

Глагол | Описание
:----: | :-------
`create` | Добавляет сущность.
`get` | Возвращает список отсортированных и отфильтрованных данных с помощью [критериев фильтрации](#) и [методов сортировки](#). К запросу возможно применить лимит и постраничный вывод на количество получаемых данных (см. раздел [Постраничный вывод](#)). С помощью фильтров может быть так же получена одна запись, по ёё уникальному идентификатору с помощью [критериев фильтрации](#). В специальном мета-параметре возвращается общее количество записей (см. раздел [Мета-параметры](#)). С помощью специального параметра можно указать какие поля возвращать в ответном сообщении (см. раздел [Представление возвращаемых данных](#)).
`update` | Обновляет сущность с определённым идентификатором. <blockquote>Возможно частичное обновление параметров<br>При обновлении массивов обновляется весь массив целиком, т.е все элементы которые не были переданы удаляются.<br>Для зануления необязательного параметра нужно передать `null`</blockquote>
`delete` | Удаляет сущность с определённым идентификатором.
`add` | Связь одного объекта с другим. К примеру добавление сотрудника в группу
`enable` | Подключение объекта
`disable` | Отключение объекта
`set` | Простановка свойства на другой объект, к примеру установка тега на обращение
`unset` | Снятие свойства с другого объека, к примеру установка тега и снятие тега

### Общая JSON структура глагола "get"

#### Запрос

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "filter":{

    },
    "sort":[
      {
        "field":"string",
        "order":"string"
      }
    ],
    "fields":[
      "string"
    ],
    "offset":"number",
    "limit":"number"
  }
}
```

#### Запрос

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "result":{
    "success":"true",
    "metadata":{
      "api_version":{
        "current_version_deprecated":"boolean",
        "current_version":"string",
        "latest_version":"string"
      },
      "limits":{
        "day_limit":"number",
        "day_remaining":"number",
        "day_reset":"number",
        "minute_limit":"number",
        "minute_remaining":"number",
        "minute_reset":"number"
      },
      "total_items":"number"
    },
    "data":[
      {
        "data":"data"
      }
    ]
  }
}
```

## Критерии фильтрации

Фильтрация данных применяется только к глаголу `"get"` (см. раздел [Глаголы используемые в именовании методов](#)) с помощью необязательного примитива `"filter"`, который является объектом и может содержать:
1. Простой фильтр;
2. Дерево фильтров которое содержит простые фильтры с условиями.

Простой фильтр - это объект, который содержит в себе обязательные примитивы:
* `field` - поле сущности к которой будет применяться фильтрация (список заранее определён для метода);
* `operator` - оператор фильтрации. В таблице 6 представлен список всех операторов фильтрации;
* `value` - значение для оператора фильтрации. Необязательное поле, если оно отсутствует, то считается пустота.

Дерево фильтров содержит специальный примитив `"filters"`, который может содержать в себе как простые фильтры, так и дерево фильтров.

> Список полей, которые перечисляются в поле `field` определяются для каждого метода индивидуально. Поля, к которым могут применяться фильтры должны иметь индексы в БД.

### Возможные ошибки при фильтрации

Текст | Код | Мнемоника | Описание
----- | --- | --------- | --------
*Filter by parameter is prohibited* | `-32602` | `filter_prohibited` | Фильтрация по параметру запрещена и невозможна, так как параметр для фильтрации не находится в списке разрешенных для фильтрации
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Передан ошибочный параметр или параметр, которого не существует

### Пример JSON структуры простого фильтра

Получаем список записей у которых поле `"name"` имеет имя `"Bob"`

```json
{
  "jsonrpc":"2.0",
  "id":1,
  "method":"get.entity",
  "params":{
    "filter":{
      "field":"name",
      "operator":"eq",
      "value":"Bob"
    }
  }
}
```

### Пример JSON структуры дерева фильтров с одним уровнем вложенности

Получаем список записей у которых поле `"name"` имеет имя `"Bob"` и его возраст 25 лет

```json
{
  "jsonrpc":"2.0",
  "id":1,
  "method":"get.entity",
  "params":{
    "filter":{
      "filters":[
        {
          "field":"name",
          "operator":"eq",
          "value":"Bob"
        },
        {
          "field":"age",
          "operator":"eq",
          "value":25
        }
      ],
      "condition":"and"
    }
  }
}
```

### Пример JSON структуры дерева фильтров с двойным уровнем вложенности

Получаем список записей у которых поле `"name"` имеет имя `"Bob"` и его возраст 25 лет или список записей у которых поле `"name"` имеет имя `"Dexter"` и его возраст 2 года

```json
{
  "jsonrpc":"2.0",
  "id":1,
  "method":"get.entity",
  "params":{
    "filter":{
      "filters":[
        {
          "filters":[
            {
              "field":"name",
              "operator":"eq",
              "value":"Bob"
            },
            {
              "field":"age",
              "operator":"eq",
              "value":25
            }
          ],
          "condition":"and"
        },
        {
          "filters":[
            {
              "field":"name",
              "operator":"eq",
              "value":"Dexter"
            },
            {
              "field":"age",
              "operator":"eq",
              "value":2
            }
          ],
          "condition":"and"
        }
      ],
      "condition":"or"
    }
  }
}
```

### Пример JSON структуры дерева фильтров с тройным уровнем вложенности

Условие запроса `((addv_comp_id = 10 or addv_comp_id = 12) and (tag_id = 1 or tag_id = 5)) or visitor_id = 14 or (date_from = 2015-12-14 and date_till = 2015-12-16)`

```json
{
  "filter":{
    "filters":[
      {
        "filters":[
          {
            "filters":[
              {
                "field":"addv_comp_id",
                "operator":"eq",
                "value":10
              },
              {
                "field":"addv_comp_id",
                "operator":"eq",
                "value":12
              }
            ],
            "condition":"or"
          },
          {
            "filters":[
              {
                "field":"tag_id",
                "operator":"eq",
                "value":1
              },
              {
                "field":"tag_id",
                "operator":"eq",
                "value":5
              }
            ],
            "condition":"or"
          }
        ],
        "condition":"and"
      },
      {
        "field":"visitor_id",
        "value":14,
        "operator":"eq"
      },
      {
        "filters":[
          {
            "field":"date_from",
            "value":"2015-12-14",
            "operator":"eq"
          },
          {
            "field":"date_till",
            "value":"2015-12-16",
            "operator":"eq"
          }
        ],
        "condition":"and"
      }
    ],
    "condition":"or"
  }
}
```

### Операторы фильтрации

> Формат для дат  
> Для дат договорились, что будет формат iso8601

> Фильтрация null и not null  
> Фильтрация будет =null, !=null 

Оператор | Описание | Учёт регистра строк | Тип данных
-------- | -------- | ------------------- | ----------
`=` | Равно | да | number, string, null, boolean, iso8601, enum
`!=` | Не равно | да | number, string, null, boolean, iso8601, enum
`<` | Меньше чем | - | number, iso8601
`>` | Больше чем | - | number, iso8601
`<=` | Меньше или равно | - | number, iso8601
`>=` | Больше или равно | - | number, iso8601
`like` | Начинается с, Заканчивается на, Содержит | да | string
`regexp` | Posix | да | string
`jsquery` | PostgreSQL jsquery | да | object, array
`in` | Массив значений в отношении "or" | да | number, string, enum

## Сортировка данных

Сортировка данных применяется только к глаголу `"get"` (см. раздел [Глаголы используемые в именовании методов](#)) с помощью массива объектов сортировки со следующими примитивами:
* `field` - поле по которому производится сортировка;
* `order` - направления сортировки. Возможные значения `"asc"`/`"desc"`. `"asc"` - по возрастанию, `"desc"` - по убыванию.  
Параметр необязателен. Значение по умолчанию `"asс"`.

> Список полей по которым можно производить сортировку определяется индивидуально для каждого метода.

### Возможные ошибки при сортировки

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Sort by parameter is prohibited* | `-32602` | `sort_prohibited` | Сортировка по параметру запрещена и невозможна, так как параметр для сортировки не находится в списке разрешенных для сортировки
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Передан ошибочный параметр или параметр, которого не существует

JSON структура:

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "sort":[
      {
        "field":"string",
        "order":"string"
      }
    ]
  }
}
```

## Постраничный вывод

Постраничный вывод может быть применён к глаголу `"get"` (см. раздел [Глаголы используемые в именовании методов](#)). Для выполнения пагинации данных используются следующие параметры:

Параметр | Значение по умолчанию | Допустимое значение | Описание
--- | --- | --- | ---
`offset` | 0 | 100 000 | сдвиг, определяет с какого номера записи возвращать `"limit"` записей
`limit` | 1000 | 10 000 | размер возвращаемых данных (количество записей)

JSON структура:

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "offset":"number",
    "limit":"number"
  }
}
```

## Мета-параметры

Возвращаются при использовании глагола `"get"` (см. раздел [Глаголы используемые в именовании методов](#)).

> Присутствуют как в ошибочном, так и в успешном ответе

> Параметр `"api_version"` возвращается только для версий которые deprecated.

JSON структура:

```json
{
  "metadata":{
    "api_version":{
      "current_version_deprecated":"boolean",
      "current_version":"string",
      "latest_version":"string"
    },
    "limits":{
      "day_limit":"number",
      "day_remaining":"number",
      "day_reset":"number",
      "minute_limit":"number",
      "minute_remaining":"number",
      "minute_reset":"number"
    },
    "total_items":"number"
  }
}
```

## Представление возвращаемых данных

### Отдельный список возвращаемых столбцов

В глаголе получения данных `"get"` (см. раздел [Глаголы используемые в именовании методов](#)) может быть указан
специальный необязательный примитив `"fields"` с типом массив, который может содержать список полей которые необходимо
показать в выводе. Если примитив `"fields"` не используется, то в выводе показываются все поля ресурса.

> Список полей индивидуален для каждого метода.  

JSON структура:

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "fields":[
      "string"
    ]
  }
}
```

### Возможные ошибки в представление возвращаемых данных

Текст | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Передан ошибочный параметр или параметр, которого не существует


## Пользователи API и аутентификация

> К пользователям и ключам доступа применяются права доступа аналогичные правам доступа в личном кабинете

### Доступ по ключу

Ключи генерируются на уровне пользователя в разделе личного кабинета "Аккаунт → Управление пользователями"  
Существует два типа ключей:
* Постоянный;
* Временный;

Постоянный ключ имеет неограниченное время действия.  
Временный ключ имеет конкретную дату окончания действия ключа.

### Доступ по логину и паролю

Используется аутентификация с использованием сессий

> Время жизни сессии конфигурируемый параметр. Значение по умолчанию 1 час.

### Доступ через oAuth

Необходимо заложить возможность использования следующего метода oAuth - [Authorization Code](https://tools.ietf.org/html/rfc6749#section-4.1)  
https://tr.dev.uiscom.ru/browse/INT-118

## Биллинг

Тип компонента | Мнемоника компонента | Название компонента | Лимиты на компонент | Список методов
--- | --- | --- | --- | ---
Корневой | `dataapi_agent` | Data API для агентов | <ul><li>`max_minute_dataapi_a gent_point` - Балов к агентским методам в минуту;</li><li>`max_day_dataapi_age nt_point` - Балов к агентским методам в день</li></ul> Значения для лимитов по умолчанию: <ul><li>`max_minute_dataapi_a gent_point = 60`</li><li>`max_day_dataapi_age nt_point = 2000`</li></ul> | [[Агенты] Управление клиентами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104067) `login.user`, `logout.user`
Корневой | `dataapi` | Data API | <ul> <li>`max_minute_dataapi_point` - Балов Data API в минуту;</li> <li>`max_day_dataapi_point` - Балов Data API в день</li> </ul> Значения для лимитов по умолчанию: <ul><li>`max_minute_dataapi_point = 60`</li><li>`max_day_dataapi_point = 2000`</li></ul> | `login.user`, `logout.user`
Подкомпонента `dataapi` | `dataapi_reports` | Data API для получения отчётов и статистики | По умолчанию максимальный период выгрузки отчёта с даты получения запроса = 3 месяца. | [Управление отчётами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104720)
Подкомпонента `dataapi` | `dataapi_provisioning` | Data API для настройки |  | [Управление SIP-линиями](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104542), [Управление АОН'ами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104358), [Управление адресной книгой](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104154), [Управление виртуальными номерами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104352), [Управление графиками активности](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104222), [Управление записанными разговорами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104690), [Управление звуковыми файлами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104407), [Управление звуковыми файлами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104407), [Управление отчётами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104720), [Управление рекламными кампаниями](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104040), [Управление сайтами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104017), [Управление сегментами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104112), [У правление сотрудниками](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104152), [Управление сценариями](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104409), [Управление тегами](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104011), [Управление уведомлениями](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104354), [Управление файлами голосовой почты](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=20185219), [Управление чёрным списком](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104156), [Управление целями](https://doc.dev.uiscom.ru/pages/viewpage.action?pageId=19104651)


## Мониторинг и метрики

> Метрики могут быть получены по HTTP в виде JSON структуры

1. Мониторинг CPU и Памяти;
1. Счётчик задержки выполнения запроса. Значение в миллисекундах;
1. Счётчик количества внутренних критических ошибок;
1. Счётчик общего количества внутренних ошибок;
1. Счётчик количество ошибочных ответов связанных с превышением лимитов;
1. Счётчик количества ошибочных ответов связанных с неправильным логином/паролем;
1. Счётчик количества успешных запросов к API;
1. Счётчик задержки ответа от БД. Значение в миллисекундах.


## Алгоритм аутентификации и авторизации агента

Кейс: Пользователь агента проходит аутентификацию и хочет выполнить действия с оболочкой своего клиента

Алгоритм:

1. Пользователь агента проходит аутентификацию по логину и паролю на сервере Data API и получает временный ключ доступа
1. Пользователь агента выполняет запрос к методу `get.customers`
1. Сервер Data API проверяет наличие permission_unit'ов `"client"` (Клиент), `"client_new"` (Новые клиенты), `"client_management"` (Управление клиентами)
1. Права есть
1. Пользователь агента выполняет запрос к методу получения списка пользователей из под которых можно делать запросы
1. Сервер Data API проверяет наличие permission_unit'ов `"client_user"` (Пользователь), `"client_user_new"` (Новый пользователь), `"client_user_all"` (Все пользователи)
1. Делает запрос к методу управления оболочкой и передает туда `user_id`, который был получен в пункте 5

Проверки, при вызове метода управления оболочкой из под пользователя агента

1. Что у пользователя агента есть права доступа к Data API
1. Что у пользователя из оболочки есть права доступа к Data API
1. Что у пользователя агента, есть доступ к клиенту и это permission `unit = "client"`
1. Что у пользователя, который указан как пользователь оболочки есть `permission_unit`, который назначен на метод

## Проверки при вызове метода

Ниже находится набор проверок, которые выполняются при вызове любого метода

* Проверяем IP в белом списке
* Проверяем, что подключен компонент

> Для агентского метода проверяется компонент `dataapi_agent`
> При вызове клиентского метода из под агента проверяется компонент `dataapi`, `dataapi_reports`, `dataapi_provisioning` на уровне клиента

* Проверяем состояние лимитов
* Проверяем стейт клиента или агента

> Для агентских методов проверяется стейт агента
> Для клиентских методов вызванных из под агента проверяется стейт клиента

* Проверяем api_permission - `dataapi`, `callapi`, `dataapi_agent`

> Если запрос делается из под агента к клиентскому методу, то для пользователя агента так же проверяется `api_permission = dataapi_agent`

* Проверяем права доступа пользователя `permission_unit`

> Если передан `user_id` или `login` с флагом `is_system = true	`, то мы такие запросы отбиваем с ошибкой `"forbidden"`

> Для токенов с флагом `is_system = true` проверки аналогичны описанным ниже, кроме того что не проверяем лимиты и подключенные компоненты.

## Список методов

**Таблица 7. Список методов и их описание**

<table>
	<tbody>
		<tr>
			<th>Название метода</th>
			<th>Вес метода</th>
			<th>Описание</th>
			<th>Data components</th>
			<th>Permission Unit</th>
			<th>select</th>
			<th>insert</th>
			<th>update</th>
			<th>delete</th>
		</tr>
		<tr>
			<td align="center" colspan="9">Общие методы</td>
		</tr>
		<tr>
			<td><code>login.users</code></td>
			<td></td>
			<td>Аутентификация: вход</td>
			<td rowspan="2">Не зависят</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>logout.users</code></td>
			<td></td>
			<td>Аутентификация: выход</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td align="center" colspan="9">Методы партнёров</td>
		</tr>
		<tr>
			<td><code>get.customers</code></td>
			<td></td>
			<td>Получить клиентов партнёра</td>
			<td rowspan="8">Не зависят</td>
			<td><code>client_selected</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.customers</code></td>
			<td></td>
			<td>Создание клиента партнёра</td>
			<td><code>client_new</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.customers</code></td>
			<td></td>
			<td>Редактирование клиента партнёра</td>
			<td><code>client_selected</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.customer_status</code></td>
			<td></td>
			<td>Изменение статуса клиента партнёра - Архивировать, Заблокировать, Активировать</td>
			<td><code>client_selected</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.customer_tariff_plans</code></td>
			<td></td>
			<td>Смена тарифного плана клиента партнёра</td>
			<td><code>client_selected</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.customer_password</code></td>
			<td></td>
			<td>Смена пароля клиенту партнёра</td>
			<td><code>client_selected</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.tariff_plans</code></td>
			<td></td>
			<td>Получение списка тарифных планов доступных партнёру</td>
			<td><code>client_selected</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code></code></td>
			<td></td>
			<td>Метод получения списка пользователей из под которых можно
вызывать методы клиента агента</td>
			<td><code>client_user</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td align="center" colspan="9">Методы клиентов и партнёров</td>
		</tr>
		<tr>
			<td colspan="9">Управление сайтами</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>create.sites</code></td>
			<td></td>
			<td>Создание сайта</td>
			<td rowspan="7">
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>,
				<code>sitephone</code>
			</td>
			<td><code>site_new</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.sites</code></td>
			<td></td>
			<td>Удаление сайта</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>get.sites</code></td>
			<td></td>
			<td>Получение списка сайтов</td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.sites</code></td>
			<td></td>
			<td>Редактирование сайта</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.site_categories</code></td>
			<td></td>
			<td>Получение списка типов сайтов</td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.site_industries</code></td>
			<td></td>
			<td>Получение списка отраслей сайта</td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.site_tracking_code</code></td>
			<td></td>
			<td>Получение кода вставки для сайта</td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.site_blocks</code></td>
			<td></td>
			<td>Создание блока для номеров</td>
			<td><code>call_trracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.site_blocks</code></td>
			<td></td>
			<td>Удаление блока для номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.site_blocks</code></td>
			<td></td>
			<td>Редактирование блока для номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.site_blocks</code></td>
			<td></td>
			<td>Получение блоков для номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.site_block_text_templates</code></td>
			<td></td>
			<td>Создание текстового шаблона номера для блока номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.site_block_image_templates</code></td>
			<td></td>
			<td>Создание шаблона номера в виде картинки для блока номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.site_block_phone_templates</code></td>
			<td></td>
			<td>Создание шаблона замены по номеру на сайте для блока
номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.site_block_templates</code></td>
			<td></td>
			<td>Удаление шаблона номера для блока номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.site_block_text_templates</code></td>
			<td></td>
			<td>Редактирование текстового шаблона номера для блока номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.site_block_image_templates</code></td>
			<td></td>
			<td>Редактирование шаблона номера в виде картинки для блока
номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.site_block_phone_templates</code></td>
			<td></td>
			<td>Редактирование шаблона замены по номеру на сайте для блока
номеров</td>
			<td><code>call_tracking</code></td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление тегами</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.tags</code></td>
			<td></td>
			<td>Получение списка тегов</td>
			<td rowspan="7">не зависят</td>
			<td><code>tag_management</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.tags</code></td>
			<td></td>
			<td>Создание тега</td>
			<td><code>tag_management</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.tags</code></td>
			<td></td>
			<td>Редактирование тега</td>
			<td><code>tag_management</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.tags</code></td>
			<td></td>
			<td>Удаление тега</td>
			<td><code>tag_management</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>set.tag_sales</code></td>
			<td></td>
			<td>Проставление тега продажа на обращение</td>
			<td><code>tag_management</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>set.tag_communications</code></td>
			<td></td>
			<td>Проставление тега на обращение</td>
			<td><code>tag_management</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>set.tag_communications</code></td>
			<td></td>
			<td>Снятие тега с обращения</td>
			<td><code>tag_management</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление сотрудниками</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.employees</code></td>
			<td></td>
			<td>Получение списка сотрудников</td>
			<td rowspan="13">не зависят</td>
			<td><code>employees</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.employees</code></td>
			<td></td>
			<td>Создание сотрудников</td>
			<td><code>employees</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.employees</code></td>
			<td></td>
			<td>Удаление сотрудника</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.employees</code></td>
			<td></td>
			<td>Редактирование сотрудника</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.group_employees</code></td>
			<td></td>
			<td>Создание группы сотрудников</td>
			<td><code>employees</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.group_employees</code></td>
			<td></td>
			<td>Удаление группы сотрудников</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>get.group_employees</code></td>
			<td></td>
			<td>Получение списка групп сотрудников</td>
			<td><code>employees</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.group_employees</code></td>
			<td></td>
			<td>Редактирование группы сотрудников</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.group_employees_numbers</code></td>
			<td></td>
			<td>Изменение приоритета и доступности номера сотрудника в
группе сотрудников</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.employee_positions</code></td>
			<td></td>
			<td>Получение списка должностей сотрудников</td>
			<td><code>employees</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.employee_positions</code></td>
			<td></td>
			<td>Создание должности сотрудника</td>
			<td><code>employees</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.employee_positions</code></td>
			<td></td>
			<td>Редактирование должности сотрудника</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.employee_positions</code></td>
			<td></td>
			<td>Удаление должности сотрудника</td>
			<td><code>employees</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td colspan="9">Управление графиками активности</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.schedules</code></td>
			<td></td>
			<td>Получение списка графиков активности</td>
			<td rowspan="4">
				<code>va</code>,
				<code>consultant</code>,
				<code>lead</code>,
				<code>sitephone</code>
			</td>
			<td><code>schedules</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.schedules</code></td>
			<td></td>
			<td>Создание графика активности</td>
			<td><code>schedules</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.schedules</code></td>
			<td></td>
			<td>Удаление графика активности</td>
			<td><code>schedules</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.schedules</code></td>
			<td></td>
			<td>Редактирование графика активности</td>
			<td><code>schedules</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление адресной книгой</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.contacts</code></td>
			<td></td>
			<td>Получение списка контактов в адресной книге</td>
			<td rowspan="12">не зависят</td>
			<td><code>address_book</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.contacts</code></td>
			<td></td>
			<td>Добавление контакта в адресную книгу</td>
			<td><code>address_book</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.contacts</code></td>
			<td></td>
			<td>Удаление контакта из адресной книги</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.contacts</code></td>
			<td></td>
			<td>Редактирование контакта в адресной книге</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.group_contacts</code></td>
			<td></td>
			<td>Создание группы контактов адресной книги</td>
			<td><code>address_book</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.group_contacts</code></td>
			<td></td>
			<td>Удаление группы контактов адресной книги</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>get.group_contacts</code></td>
			<td></td>
			<td>Получение списка групп адресной книги</td>
			<td><code>address_book</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.group_contacts</code></td>
			<td></td>
			<td>Редактирование группы контактов адресной книги</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.contact_organizations</code></td>
			<td></td>
			<td>Получение списка организаций контактов</td>
			<td><code>address_book</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.contact_organizations</code></td>
			<td></td>
			<td>Создание организации контакта</td>
			<td><code>address_book</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.contact_organizations</code></td>
			<td></td>
			<td>Редактирование организации контакта</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.contact_organizations</code></td>
			<td></td>
			<td>Удаление организации контакта</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td colspan="9">Управление чёрным списком</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.black_list</code></td>
			<td></td>
			<td>Получение списка контактов в чёрном списке</td>
			<td rowspan="3">не зависят</td>
			<td><code>address_book</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>add.black_list</code></td>
			<td></td>
			<td>Добавление контакта в чёрный список</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.black_list</code></td>
			<td></td>
			<td>Удаление одного или всех контактов из чёрного списка</td>
			<td><code>address_book</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление списками АОН'ов</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>create.ani</code></td>
			<td></td>
			<td>Создание списка АОН'ов</td>
			<td rowspan="5"><code>va</code></td>
			<td>
				<code>interfaces</code>, <code>va</code>, <code>client_user</code>,
				<code>client_user_new</code>
			</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.ani</code></td>
			<td></td>
			<td>Получение списка АОН'ов</td>
			<td>
				<code>interfaces</code>, <code>va</code>, <code>client_user</code>,
				<code>client_user_new</code>
			</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.ani</code></td>
			<td></td>
			<td>Редактирование указанного списка АОН'ов</td>
			<td>
				<code>interfaces</code>, <code>va</code>, <code>client_user</code>,
				<code>client_user_new</code>
			</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.ani</code></td>
			<td></td>
			<td>Удаление указанного списка АОН'ов или удаление АОН'а из
списка</td>
			<td>
				<code>interfaces</code>, <code>va</code>, <code>client_user</code>,
				<code>client_user_new</code>
			</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>add.ani</code></td>
			<td></td>
			<td>Добавление АОН'а в существующий список АОН'ов</td>
			<td>
				<code>interfaces</code>, <code>va</code>, <code>client_user</code>,
				<code>client_user_new</code>
			</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление сегментами</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>create.segments</code></td>
			<td></td>
			<td>Создание сегмента</td>
			<td rowspan="4">
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.segments</code></td>
			<td></td>
			<td>Редактирование сегмента</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.segments</code></td>
			<td></td>
			<td>Удаление сегмента</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>get.segments</code></td>
			<td></td>
			<td>Получение списка сегментов</td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление виртуальными номерами</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.available_virtual_numbers</code></td>
			<td></td>
			<td>Получение списка виртуальных номеров доступных для
подключения</td>
			<td rowspan="5">Не зависит</td>
			<td><code>account_access</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>enable.virtual_numbers</code></td>
			<td></td>
			<td>Подключение виртуального номера</td>
			<td><code>account_access</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>disable.virtual_numbers</code></td>
			<td></td>
			<td>Отключение виртуального номера</td>
			<td><code>account_access</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>get.virtual_numbers</code></td>
			<td></td>
			<td>Получение списка подключённых виртуальных номеров</td>
			<td><code>account_access</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.virtual_numbers</code></td>
			<td></td>
			<td>Редактирование настроек подключённого виртуального
номера</td>
			<td><code>account_access</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.virtual_number_rules</code></td>
			<td></td>
			<td>Получение списка правил для виртуального номера</td>
			<td><code>va</code></td>
			<td><code>va</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.virtual_number_rules</code></td>
			<td></td>
			<td>Удаление правила для виртуального номера</td>
			<td><code>va</code></td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>create.virtual_number_call_rules</code></td>
			<td></td>
			<td>Создание правила обработки звонка для виртуального номера</td>
			<td><code>va</code></td>
			<td><code>va</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.virtual_number_callout_rules</code></td>
			<td></td>
			<td>Создание Callout правила для виртуального номера</td>
			<td><code>callout</code></td>
			<td><code>va</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.virtual_number_callback_rules</code></td>
			<td></td>
			<td>Создание Callback правила для виртуального номера</td>
			<td><code>callback</code></td>
			<td><code>va</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.virtual_number_call_rules</code></td>
			<td></td>
			<td>Редактирование правила обработки звонка для виртуального
номера</td>
			<td><code>va</code></td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.virtual_number_callout_rules</code></td>
			<td></td>
			<td>Редактирование Callout правила для виртуального номера</td>
			<td><code>callout</code></td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.virtual_number_callback_rules</code></td>
			<td></td>
			<td>Редактирование Callback правила для виртуального номера</td>
			<td><code>callback</code></td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.user_numbers</code></td>
			<td></td>
			<td>Добавление пользовательских номерами</td>
			<td rowspan="4"><code>call_tracking</code></td>
			<td><code>account_access</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.user_numbers</code></td>
			<td></td>
			<td>Удаление пользовательских номеров</td>
			<td><code>account_access</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.user_numbers</code></td>
			<td></td>
			<td>Редактирование пользовательских номеров</td>
			<td><code>account_access</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.user_numbers</code></td>
			<td></td>
			<td>Получение списка пользовательских номеров</td>
			<td><code>account_access</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление SIP-линиями</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.sip_lines</code></td>
			<td></td>
			<td>Получение списка SIP-линий</td>
			<td rowspan="5"><code>va</code></td>
			<td><code>va</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.sip_lines</code></td>
			<td></td>
			<td>Создание SIP-линии</td>
			<td><code>va</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.sip_lines</code></td>
			<td></td>
			<td>Редактирование SIP-линии</td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.sip_lines</code></td>
			<td></td>
			<td>Удаление SIP-линии</td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.sip_line_password</code></td>
			<td></td>
			<td>Генерация нового пароля для SIP-линии</td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление записанными разговорами</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.call_records</code></td>
			<td></td>
			<td>Получение списка записанных разговоров</td>
			<td rowspan="2"><code>va</code></td>
			<td><code>call_recordings_employee</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.call_records</code></td>
			<td></td>
			<td>Удаление записи разговора</td>
			<td><code>call_recordings_employee</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td colspan="9">Управление уведомлениями</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>create.notifications</code></td>
			<td></td>
			<td>Создание уведомления</td>
			<td rowspan="4"><code>notification</code></td>
			<td><code>notifications</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.notifications</code></td>
			<td></td>
			<td><code>notifications</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.notifications</code></td>
			<td></td>
			<td><code>notifications</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.notifications</code></td>
			<td></td>
			<td><code>notifications</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td colspan="9">Управление отчётами и статистикой</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.communications_report</code></td>
			<td></td>
			<td>Получение списка всех обращений</td>
			<td>Не зависит</td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.calls_report</code></td>
			<td></td>
			<td>Получение отчёта по сессиям звонков</td>
			<td>Не зависит</td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.call_legs_report</code></td>
			<td></td>
			<td>Получение отчета по CDR сессии звонка</td>
			<td>Не зависит</td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.goals_report</code></td>
			<td></td>
			<td>Получение списка достигнутых целей</td>
			<td>
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.chats_report</code></td>
			<td></td>
			<td>Получение информации о чатах</td>
			<td><code>consultant</code></td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.chat_messages_report</code></td>
			<td></td>
			<td>Получение всех сообщений чата</td>
			<td><code>consultant</code></td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.offline_messages_report</code></td>
			<td></td>
			<td>Получение информации по оффлайн заявкам</td>
			<td>
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.visitor_sessions_report</code></td>
			<td></td>
			<td>Получение информации о сессии посетителя</td>
			<td>
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td><code>visitor_contact_details</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.visitors_report</code></td>
			<td></td>
			<td>Получение информации о посетителе</td>
			<td>
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td><code>visitor_contact_details</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.sales_report</code></td>
			<td></td>
			<td>Получение списка сделок</td>
			<td>
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td>не нужны</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.financial_summary_report</code></td>
			<td></td>
			<td>Получение общего отчёта истории списаний</td>
			<td rowspan="2">Не зависит</td>
			<td><code>account_access</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.financial_call_legs_report</code></td>
			<td></td>
			<td>Получение детализированного отчёта истории списаний по
звонкам</td>
			<td><code>account_access</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.api_requests_report</code></td>
			<td></td>
			<td>Получение отчёта по запросам ко всем видам API</td>
			<td>
				<code>dataapi</code>,
				<code>callapi</code>
			</td>
			<td><code>admin_interfaces</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление звуковыми файлами</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.media_files</code></td>
			<td></td>
			<td>Получение списка пользовательских и системных звуковых
файлов</td>
			<td><code>va</code></td>
			<td><code>va</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление сценариями</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.scenarios</code></td>
			<td></td>
			<td>Получение списка сценариев</td>
			<td><code>va</code></td>
			<td><code>va</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление оставленными голосовыми сообщениями</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.voice_mail_records</code></td>
			<td></td>
			<td>Получение списка оставленных голосовых сообщений</td>
			<td rowspan="2"><code>va</code></td>
			<td><code>va</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.voice_mail_records</code></td>
			<td></td>
			<td>Удаление оставленного голосового сообщения</td>
			<td><code>va</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td colspan="9">Управление рекламными кампаниями</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>get.campaigns</code></td>
			<td></td>
			<td>Получение списка рекламных кампаний</td>
			<td rowspan="7">
				<code>call_tracking</code>,
				<code>lead</code>,
				<code>consultant</code>
			</td>
			<td>
				<code>ac</code> or <code>ac_ext</code> or
				<code>ac_undefined</code>
			</td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>create.campaigns</code></td>
			<td></td>
			<td>Создание рекламной кампании</td>
			<td><code>ac_new</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.campaigns</code></td>
			<td></td>
			<td>Удаление рекламной кампании</td>
			<td><code>ac</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
		<tr>
			<td><code>update.campaigns</code></td>
			<td></td>
			<td>Редактирование рекламной кампании</td>
			<td>
				<code>ac</code> or <code>ac_ext</code> or
				<code>ac_undefined</code>
			</td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.campaign_parameter_weights</code></td>
			<td></td>
			<td>Получение весов параметров рекламных кампаний</td>
			<td>
				<code>ac</code> or <code>ac_ext</code> or
				<code>ac_undefined</code>
			</td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.campaign_parameter_weights</code></td>
			<td></td>
			<td>Редактирование весов параметров рекламных кампаний</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.price_dynamic_call_tracking</code></td>
			<td></td>
			<td>Получение стоимости виртуальных номеров для динамического
call tracking</td>
			<td>
				<code>ac</code> or <code>ac_ext</code> or
				<code>ac_undefined</code>
			</td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td colspan="9">Управление целями</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>select</td>
			<td>insert</td>
			<td>update</td>
			<td>delete</td>
		</tr>
		<tr>
			<td><code>create.goals</code></td>
			<td></td>
			<td>Создание цели</td>
			<td rowspan="4">
				<code>call_tracking</code>,
				<code>consultant</code>,
				<code>lead</code>
			</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td>*</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>update.goals</code></td>
			<td></td>
			<td>Редактирование цели</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td>*</td>
			<td></td>
		</tr>
		<tr>
			<td><code>get.goals</code></td>
			<td></td>
			<td>Получение целей</td>
			<td><code>site_settings</code></td>
			<td>*</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><code>delete.goals</code></td>
			<td></td>
			<td>Удаление целей</td>
			<td><code>site_settings</code></td>
			<td></td>
			<td></td>
			<td></td>
			<td>*</td>
		</tr>
	</tbody>
</table>


## Общие поля для всех методов

**Таблица 7. Общие поля для всех методов**

Название | Тип  | Обязательный | Допустимые значения | Описание
:------- | :--- | :----------: | :-----------------: | :-------
`id` | string или number | да |  | Уникальный идентификатор запроса к API <blockquote>Не передается в уведомлениях. Фигурирует только в "Отчет по запросам к API" параметр `"request_id"`</blockquote>
`method` | string | да |  | Вызываемый метод (см. таблицу 7 Список методов) 
`jsonrpc` | string | да | 2.0 | Номер спецификации JSON-RPC
`params` | object | да |  | Содержит тело запроса к API. В зависимости от вызываемого метода тело запроса меняется.


## Общие методы

### Аутентификация

#### Вход

Метод | `login.user`
:---- | :---------------
Версия API | v2
Статус | не реализован
Описание | Вход и получение ключа сессии аутентификации
Кому доступен | Партнёр, Клиент

> Создаем на каждый логин отдельную сессию

> Необходима реализация защиты от подбора пароля.  
> Предлагается следующий вариант: писать в лог сообщение о неверном логине/пароле в котором будет IP адрес с которого происходит обращение. Далее с помощью `fail2ban` производить анализ логов и если количество обращений с неправильным логином и паролем превышает N, то добавить IP адрес в Iptables на N секунд.

##### Параметры запроса

Название | Тип  | Обязательный | Допустимые значения | Описание
:------- | :--- | :----------: | :------------------ | :-------
`login` | string | да |  | Логин пользователя
`password` | string | да |  | Пароль пользователя

##### Параметры ответа

Название | Тип  | Обязательный | Допустимые значения | Описание
:------- | :--- | :----------: | :------------------ | :-------
`access_token` | string | да |  | Ключ сессии аутентификации
`expire_at` | number | да |  | Timestamp когда выданный токен перестанет быть валидным
`customer_id` | number | да |  | Уникальный идентификатор клиента. Всегда возвращается <blockquote>Всегда возвращается `customer_id`, которому принадлежит авторизовавшийся пользователь.</blockquote><blockquote>Может быть необходим для технологических партнёров к примеру для мапинга уведомлений</blockquote>

> Время жизни полученного ключа сессии аутентификации после вызова метода `"login.user"` - 1 час. По истечению времени жизни ключа сессии его необходимо запрашивать заново, т.е. вызывать метод `"login.user"`.

> Для совершения запросов к API возможно использование постоянного ключа аутентификации, который доступен в Личном кабинете.

##### JSON структура запроса

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"login.user",
  "params":{
    "login":"string",
    "password":"string"
  }
}
```

##### JSON структура ответа

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "result":{
    "data":{
      "access_token":"string",
      "expire":"number",
      "customer_id":"number",
      "success":"true"
    }
  }
}
```

#### Выход

Метод | `logout.user`
:---- | :---------------
Версия API | v3
Статус | не реализован
Описание | Выход и удаление ключа сессии аутентификации
Кому доступен | Партнёр, Клиент

##### Параметры метода

Название | Тип  | Обязательный | Допустимые значения | Описание
:------- | :--- | :----------: | :------------------ | :-------
`access_token` | string | да |  | Ключ сессии аутентификации

##### JSON структура запроса

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"logout.users",
  "params":{
    "access_token":"string"
  }
}
```

##### JSON структура ответа

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "result":{
    "data":{
      "success":"true"
    }
  }
}
```