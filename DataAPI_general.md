# Data API v2.x

**Change History**

Version | Date | Comment
:------ | :--- | :------
[Current Version (v. 278)](https://doc.dev.uiscom.ru/display/projects/viewpage.action?pageId=19103909) | May 31, 2017 15:25 | Ивченко Максим
[v. 277](https://doc.dev.uiscom.ru/display/projects/viewpage.action?pageId=39817995) | May 23, 2017 14:18 | Ивченко Максим
[v. 276](https://doc.dev.uiscom.ru/display/projects/viewpage.action?pageId=39816579) | May 23, 2017 14:17 | Ивченко Максим

**Contributors**

[Ивченко Максим](https://doc.dev.uiscom.ru/display/~ivchenko) 272 (14 days ago), [Белобородов Дмитрий](https://doc.dev.uiscom.ru/display/~beloborodov) 1 (372 days ago), [Васильев Святослав](https://doc.dev.uiscom.ru/display/~vasiliev) 5 (503 days ago)

**Watchers**

[Бочаров Василий](https://doc.dev.uiscom.ru/display/~bocharov), [Бродский Илья](https://doc.dev.uiscom.ru/display/~brodskiy), [Васильев Святослав](https://doc.dev.uiscom.ru/display/~vasiliev), [Вязовцев Денис](https://doc.dev.uiscom.ru/display/~vyazovtsev), [Гогов Станислав](https://doc.dev.uiscom.ru/display/~gogov), [Гузикова Анастасия](https://doc.dev.uiscom.ru/display/~guzikova), [Дешевых Степан](https://doc.dev.uiscom.ru/display/~deshevyh), [Дмитриев Илья](https://doc.dev.uiscom.ru/display/~dmitriev), [Ефимова Мария](https://doc.dev.uiscom.ru/display/~efimova), [Ивченко Максим](https://doc.dev.uiscom.ru/display/~ivchenko), [Кисляков Дмитрий](https://doc.dev.uiscom.ru/display/~kislyakov), [Кузнецов Игорь](https://doc.dev.uiscom.ru/display/~ikuznetsov), [Лысогорский Дмитрий](https://doc.dev.uiscom.ru/display/~lysogorskii), [Нехорошев Артем](https://doc.dev.uiscom.ru/display/~nekhoroshev), [Павлова Ольга](https://doc.dev.uiscom.ru/display/~borisova), [Пащенко Валерий](https://doc.dev.uiscom.ru/display/~pashchenko), [Семенов Михаил](https://doc.dev.uiscom.ru/display/~semenov), [Серебряков Павел](https://doc.dev.uiscom.ru/display/~serebryakov), [Сидоров Никита](https://doc.dev.uiscom.ru/display/~sidorov), [Спасский Павел](https://doc.dev.uiscom.ru/display/~spasskij), [Сычугов Антон](https://doc.dev.uiscom.ru/display/~sychugov), [Хлебущев Александр](https://doc.dev.uiscom.ru/display/~khlebushchev), [Черняков Андрей](https://doc.dev.uiscom.ru/display/~chernyakov), [Юрченко Надежда](https://doc.dev.uiscom.ru/display/~hr_uis)

## Важные проблемы

`P1` На текущий момент таймаут на выполнение запроса в БД = 240 секунд. На уровне Nginx = 300 секунд. По
истечение времени ожидания (таймаута) ответа от БД запрос заканчивается с ошибкой `request_timeout`. В результате этого
следующий запрос к БД падает с проблемой, которая описана в задаче [ARCH-32](https://tr.dev.uiscom.ru/browse/ARCH-32) 

Возможное решение предлагалось в задаче [INT-1778](https://tr.dev.uiscom.ru/browse/INT-1778) но оно не сработало.
Проблема осталась.

Для того чтобы понять сколько таких запросов, нужно сделать grep по логам Data API сервера. Строка поиска
`"api.jsonrpc.errors.RequestTimeoutError"`

## Общая информация

Настоящий документ описывает Data API, которое позволяет получать/добавлять/удалять/редактировать сущностинеобходимые для работы сервисов CoMagic и UIS. API реализован на основе спецификации [JSON-RPC 2.0](http://www.jsonrpc.org/specification) без поддержкигрупповых операций. При запросах к API в качестве транспортного протокола используется [HTTP/1.1](http://tools.ietf.org/html/rfc2616) с защитой соединения спомощью SSL/TLS, при этом соблюдая следующие требования:

* Заголовок Content-Type должен быть `"application/json; charset=UTF-8"`
* Заголовок Content-Length должен содержать корректную длину сообщения, следуя спецификации [HTTP/1.1](http://tools.ietf.org/html/rfc2616)

> На функциональность не должно влиять, т.е это касается только уровня транспорта. Мы договорились, что не привязываемся в части функционала к конкретному транспорту. Т.е клиент не должен передавать указанные заголовки.

## Важные замечания

> При каждом вызове метода API необходимо проверять, что компонент API активен в профиле аккаунта клиента (см. [Биллинг](#))

> Должна быть проверка на статус клиента. Для неактивного клиента доступ к API должен быть запрещён

> Проверять ограничения тарифного плана, т.е многие методы могут быть недоступны так как не подключены соответствующие компоненты.
> Для каждого метода нужно проверять, что подключён соответствующий компонент

> В Redis должно быть отдельное пространство для API, т.е все данные которые связаны с API должны храниться с префиксом, к примеру `rpc_api`

> Ограничиваем размер JSON'а 100Kb + код ошибки из HTTP 413

> Проверять принадлежность виртуального номера клиенту

> При отключении компонента `"dataapi"` (см. [Биллинг](#)) у всех пользователей и ключей должен быть удален доступ к Data API

> Возможно использовать `fail2ban`
> Добавляем в вывод в лог следующих событий:
> * IP адрес не находится в белом списке
> * Логин/Пароль указан неверно
> * Ключ доступа не найден, т.е пришли с постоянным ключом, а он неактивен или просто такого не существует
> * Версия не найдена, т.е пришли на ошибочный URL
> Сообщение об ошибке обязательно должно содержать в себе:
> * IP источника запроса
> * Дата и время запроса
> * Сообщение об ошибке

## Соглашения

Приняты следующие соглашения при использовании API:

* Пустые поля всегда возвращаются в ответе со значением `null`. В случае массива возвращается пустой массив, в случае объекта возвращается пустой объект;
* Все поля связанные с датой и временем передаются согласно ISO 8601 в формате YYYY-MM-DDT hh:mm:ssZ;
* Запросы к API выполняются всегда с помощью метода POST;
* Все параметры в запросах/ответах, а также в структурах данных в формате JSON и название методов именуются в стиле Snake Case - разделение слов через нижнее подчёркивание;
* Данные возвращаются только в JSON формате согласно спецификации [RFC 7159](https://tools.ietf.org/html/rfc7159);
* Кодировка данных UTF-8;

## Формат возвращаемых данных

**Таблица 1. Поддерживаемые форматы возвращаемых данных**

Формат | MIME Type
:----- | :--------
JSON | application/json

> По умолчанию используется формат JSON. Заголовок Accept игнорируется

## Базовый URL для доступа к API

Базовый для доступа к URI API соответствует следующему шаблону:

```
<protocol> :// <hostname> / <version>
```

* `<protocol>` - https;
* `<hostname>` - FQDN;
* `<version>` - версия API (см. раздел [Версионность](#))

> API должен быть доступен по следующим URL:  
> Клиентское API: https://api.uiscom.ru/<version> и https://api.comagic.ru/<version>

## Версионность

Data API поддерживает версионность. Версия указывается в базовом URL как `vX.Y`, где `X` - номер мажорной версии, `Y` - номер минорной версии

> Версия может указываться через точку, т.е может быть к примеру `2.1`

> Если была выпущена новая версия, то старая считается устаревшей и соответственно при обращении к старой версии API в мета-параметрах (см. раздел [Мета-парамметры](#)) будет возвращаться параметр `"current_version_deprecated"` со значением `"true"`

Пример:  
http://api.uiscom.ru/v4.0  
http://api.comagic.ru/v4.0

> Максимальное количество поддерживаемых версий - 2  
> Период поддержки устаревшей версии 2 месяца

## Лимиты и ограничения

> Балы списываются только за успешные запросы, т.е в отчете по запросам он помечен как успешный. Успешным считается запрос, если в `"result"` был возвращен статус `"success" = true` или идентификатор сессии звонка

> Лимиты привязаны к базовому компоненту `"dataapi"` (см. [Биллинг](#)) и учитываются в зависимости от веса метода  
> Информация о лимитах возвращается во всех ответах в мета-парметрах (см. [Мета-параметры](#)) кроме случаев когда лимиты не учитываются;

Лимиты построены по бальной системе, т.е каждый метод имеет свой вес. Вызов метода уменьшает доступные

дневные/минутные балы на размер веса вызываемого метода
Лимиты возвращаются на каждый успешный/ошибочный ответ в мета-параметрах, см. раздел "[Мета-параметры](#)"

**Таблица 3. Возвращаемые параметры**

Название параметра | Описание
:----------------- | :-------
`day_limit` | Текущие лимит запросов в день
`day_remaining` | Какое количество запросов осталось до достижения дневного лимита
`day_reset` | Время в секундах через которое дневной лимит будет сброшен
`minute_limit` | Текущие лимит запросов за минуту
`minute_remaining` | Какое количество запросов осталось до достижения минутного лимита
`minute_reset` | Время в секундах через которое минутный лимит будет сброшен

### Расширение лимитов

На страницу "Аккаунт" -> "Тарифы и опции" добавить возможность покупки компонентов (см. Биллинг) и расширения лимитов.

Название лимитов:
* `max_minute_dataapi_point` - Балов Data API в минуту;
* `max_day_dataapi_point` - Балов Data API в день

Максимальное значение для расширения лимитов:
* Количество балов в минуту - максимальное значение `ЗАПРОСИТЬ У СЛАВЫ` ;
* Количество балов в день - максимальное значение `ЗАПРОСИТЬ У СЛАВЫ` ;


## Обработка ошибок

> Предлагается вести конфигурационный файл, который содержит маппинг мнемокода ошибки `"mnemocode"` с параметром `"extended_helper"`

### Параметры сообщения об ошибке

Название | Тип  | Обязательный | Допустимые значения | Описание
:------- | :--- | :----------: | :------------------ | :-------
`error` | object | да |  | Объект с содержимым ошибки
`code` | number | да |  | Код ошибки (см. раздел [Коды ошибок](#) )
`message` | string | да |  | Cообщение об ошибке (см. раздел [Коды ошибок](#) ) <blockquote>В тексте сообщения возможно использовать параметры замены: <br>`{field}`, `{value}`, параметры из поля `"params"` `{'name1': 'value1', 'name2': 'value2', ...}`, при форматировании эти параметры должны быть названы `{name1}`, `{name2}` и т.д., и вместо них подставляются соответствующие значения</blockquote>
`data` | object | да |  | Объект с деталями ошибки
`mnemonic` | string | да |  | Уникальный текстовый код ошибки
`value` | string | нет |  | Содержит то, что передал пользователь без изменений <blockquote>В некоторых случаях может отсутствовать. К примеру, обязательный параметр вообще не был заполнен.</blockquote>
`extended_helper` | string | нет |  | Ссылка на более подробное описание ошибки и возможные решения
`params` | object | нет |  | Карта подстановок параметров для шаблона с текстом об ошибке. Т.е. содержит динамически изменяемые значения, к примеру, лимиты. Значения указанные в этом параметре могут быть использованы в сообщениях об ошибках в интерфейсе над Call API (рабочее место оператора).
`field` | string | нет |  | Название параметра, с которым связана ошибка <blockquote>Вложенные параметры отображаем через разделитель точка "."<br>К примеру: `"employee.phone_number"`</blockquote><blockquote>Необходимо всегда заполнять, так как мы всегда знаем ошибочный параметр</blockquote>

### JSON структура ошибки

```json
{
  "jsonrpc":"2.0",
  "id":null,
  "error":{
    "code":"number",
    "message":"string",
    "data":{
      "mnemonic":"string",
      "field":"string",
      "value":"string",
      "params":{
        "object":"string"
      },
      "extended_helper":"string"
    }
  }
}
```

### Группы кодов ошибок

Код ошибки | Описание
---------- | --------
`-32700` | Ошибки связанные с валидацией JSON
`-32600` | Ошибки связанные с валидацией параметров запроса - `id`, `jsonrpc`
`-32601` | Ошибки связанные с методом
`-32602` | Ошибки связанные с валидацией параметров в вызываемом методе
`-32603` | Внутренние ошибки JSON RPC сервера
`-32001` | Ошибки аутентификации и ошибки с ключами
`-32002` | Ошибки связанные с: правила безопасности запрещают звонок по указанному направлению (см. раздел [Правила безопасности](#)) и черным списком
`-32003` | Ошибки с правами доступа - ip адрес не в белом списке, нет прав у пользователя
`-32004` | Ошибки связанные с неверной последовательностью вызываемых методов
`-32007` | Ошибки связанные с виртуальным номером
`-32008` | Ошибки связанные с компонентами
`-32009` | Ошибки связанные с аккаунтом заказчика
`-32029` | Ошибки связанные с лимитами
`-32099` | Ошибки связанные с поддержкой различных частей спецификации JSON RPC 2.0 - Групповые операции, Уведомления

### Список ошибок общих для всех методов

Текст сообщение | Код | Мнемоника | Описание
--------------- | --- | --------- | --------
*Invalid Request The JSON sent is not a valid Request object* | `-32600` |  `invalid_request` | Ошибки связанные с валидацией параметров запроса - `id`, `jsonrpc`
*Access token has been expired* | `-32001` | `access_token_expired` |  Применяется только к постоянному токену. Если время жизни постоянного токена истекло, то возвращается указанная ошибка
*Access token has been blocked* | `-32001` | `access_token_blocked` | Если постоянный токен заблокирован, то возвращается указанная ошибка
*Access token is invalid* | `-32001` | `access_token_invalid` | Указанная ошибка возвращается если постоянный/временный токен не найден
*Limit per `{limit_type}` has been exceeded. Value of current limit per `{limit_type}` is `{limit_max_value}`* | `-32029` | `limit_exceeded` | 
*You need at least on of the following components to access this method: `{components}`* | `-32008` | `method_component_disabled` | Если у клиента не подключен компонент, который требуется для работы метода
*You need at least on of the following components to access this paremeter: `{components}`* | `-32008` | `parameter_component_disabled` | Если у клиента не подключен компонент, который нужен для заполнения параметра и создания сущности
*Your IP `{ip}` is not whitelisted* | `-32003` | `ip_not_whitelisted` |  
*Login or password is wrong* | `-32001` | `auth_error` |
*Your account has been disabled, contact the support service* | `-32009` | `account_inactive` | Аккаунт `app_id` заблокирован
*Internal error, contact the support service* | `-32603` | `internal_error` | 
*Data supplied is of wrong type* | `-32602` | `data_type_error` | К примеру, если ожидаем string а передали int
*The method does not exist / is not available* | `-32601` | `method_not_found` |
*Permission denied* | `-32003` | `forbidden` | Нет прав на доступ к методу или API, или запрещено выполнять какое-либо действие
*Invalid JSON was received by the server.* | `-32700` `parse_error` |
*Batch operations not supported* | `-32099` | `batch_opreations_not_supported` | 
*Notifications not supported* | `-32099` | `notifications_not_supported` |
*The required parameter has been missed* | `-32602` | `required_parameter_missed` | Обязательный параметр не передали
*Invalid parameter value* | `-32602` | `invalid_parameter_value` | Возвращается во всех случаях, если было передано некорректное значение параметра или переданное значение не соответствует требуемому формату ввода
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Если в `"params"` были переданы параметры которые не предусмотрены JSON структурой метода или указан параметр для сортировки, фильтрации и выборки, который не существует
*The combination of parameters is not permitted* | `-32602` | `invalid_parameters_combination` | Если параметры указанные в методе находятся в недопустимой комбинации. Нужно смотреть документацию по методу и его параметрам.
*`{error_message}`* | `-32602` | `error` | Договорились о следующем: <br> В БД могут возникнуть Exceptions или SMART ERROR и стараемся при получении такой ошибки на стороне БД замапить в существующие мнемоники, если они не мапятся, то возвращаем ошибку `"error"` и уже в нее передаем текст ошибки из БД, но важно исключить слово `"SMART ERROR"` и текста ошибки

### Список ошибок для методов с глаголом get

> Возможны ошибки, которые находятся в разделе ["Список ошибок общих для всех методов"](#)

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Invalid parameter value* | `-32602` | `invalid_parameter_value` | Если в фильтрах было передано некорректное значение для regexp, jsquery и ли любых значений не соответствующих документации
*Sort by parameter is prohibited* | `-32602` | `sort_prohibited` | Сортировка по параметру запрещена и невозможна, так как параметр для сортировки не находится в списке разрешенных для сортировки
*Filter by parameter is prohibited* | `-32602` | `filter_prohibited` | Фильтрация по параметру запрещена и невозможна, так как параметр для фильтрации не находится в списке разрешенных для фильтрации
*Data supplied is of wrong type* | `-32602` | `data_type_error` | К примеру, если ожидаем string а передали int
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Если в `"params"` были переданы параметры которые не предусмотрены JSON структурой метода или указан параметр для сортировки, фильтрации и выборки, который не существуе
*Max value of requested date interval is 3 months* | `-32602` | `date_interval_limit_reached` | Если в запросе период между указанными датами в `date_from` и `date_till` превышает 3 месяца. В основном ошибка актуальна только для методов получения отчетов, но не для всех.

### Список ошибок общих для методов с глаголом delete

> Возможны ошибки, которые находятся в разделе ["Список ошибок общих для всех методов"](#)

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Entity not found* | `-32602` | `entity_not_found` | Если передан уникальный идентификатор сущности, которая не найдена у `app_id`
*The required parameter has been missed* | `-32602` | `required_parameter_missed` | Обязательный параметр не передали
*You have interdependet entities* | `-32602` | `dependency_error` | Удаляемая сущность используется в других сущностях. Чтобы удалить, необходимо убрать удаляемую сущность из всех возможных настроек
*Permission denied* | `-32602` | `forbidden` | Удалить сущность невозможно так как она системная, к примеру группа "Черный список" в адресной книге

### Список ошибок общих для методов с глаголом create и update, set, unset

> Возможны ошибки, которые находятся в разделе ["Список ошибок общих для всех методов"](#)

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Entity not found* | `-32602` | `entity_not_found` | Если передан уникальный идентификатор сущности, которая не найдена у `app_id`
*Duplicate entity* | `-32602` | `duplicate_entity` | Если сущность уже существует в рамках `app_id`
*The required parameter has been missed* | `-32602` | `required_parameter_missed` | Обязательный параметр не передали
*Unexpected method parameter(s)* | `-32602` | `invalid_parameter_value` | Если в `"params"` были переданы параметры которые не предусмотрены JSON структурой метода или указаны значения не соответствующие допустимым значениям
*A new data limit has been exceeded* | `-32602` | `data_limit_exceeded` | Ошибка возникает в случае, если у клиента было достигнуто максимальное количество данных в таблицах конфигурации сервиса. количество данных определяется количеством строк и принятое ограничение установлено в 100 000 строк
*Добавляю ошибку `tariff_restrictions` `-32602` Action is not
allowed for your tariff plan. You need contact support service
or change your tariff plan settings in your account. Когда
возникают ограничения тарифного плана* | `-32602` | `tariff_restrictions` | Любые ограничения тарифного плана

## Поддержка языковых схем

Функционал не поддерживается

## Групповые операции

Функционал не поддерживается

## Принцип именования методов

Имя JSON-RPC метода состоит из двух частей разделенных точкой: глагола и имени объекта. Глаголы соответствуют концепции CRUD.

Имя объекта выбирается как существительное во множественном числе, отражающее бизнес-сущность, например `subscribers`.

Имя метода должно начинаться с глагола, отражающего суть операции.

### Глаголы используемые в именовании методов

**Таблица 5. Глаголы используемые в именовании методов**

Глагол | Описание
:----: | :-------
`create` | Добавляет сущность.
`get` | Возвращает список отсортированных и отфильтрованных данных с помощью [критериев фильтрации](#) и [методов сортировки](#). К запросу возможно применить лимит и постраничный вывод на количество получаемых данных (см. раздел [Постраничный вывод](#)). С помощью фильтров может быть так же получена одна запись, по ёё уникальному идентификатору с помощью [критериев фильтрации](#). В специальном мета-параметре возвращается общее количество записей (см. раздел [Мета-параметры](#)). С помощью специального параметра можно указать какие поля возвращать в ответном сообщении (см. раздел [Представление возвращаемых данных](#)).
`update` | Обновляет сущность с определённым идентификатором. <blockquote>Возможно частичное обновление параметров<br>При обновлении массивов обновляется весь массив целиком, т.е все элементы которые не были переданы удаляются.<br>Для зануления необязательного параметра нужно передать `null`</blockquote>
`delete` | Удаляет сущность с определённым идентификатором.
`add` | Связь одного объекта с другим. К примеру добавление сотрудника в группу
`enable` | Подключение объекта
`disable` | Отключение объекта
`set` | Простановка свойства на другой объект, к примеру установка тега на обращение
`unset` | Снятие свойства с другого объека, к примеру установка тега и снятие тега

### Общая JSON структура глагола "get"

#### Запрос

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "filter":{

    },
    "sort":[
      {
        "field":"string",
        "order":"string"
      }
    ],
    "fields":[
      "string"
    ],
    "offset":"number",
    "limit":"number"
  }
}
```

#### Запрос

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "result":{
    "success":"true",
    "metadata":{
      "api_version":{
        "current_version_deprecated":"boolean",
        "current_version":"string",
        "latest_version":"string"
      },
      "limits":{
        "day_limit":"number",
        "day_remaining":"number",
        "day_reset":"number",
        "minute_limit":"number",
        "minute_remaining":"number",
        "minute_reset":"number"
      },
      "total_items":"number"
    },
    "data":[
      {
        "data":"data"
      }
    ]
  }
}
```

## Критерии фильтрации

Фильтрация данных применяется только к глаголу `"get"` (см. раздел [Глаголы используемые в именовании методов](#)) с помощью необязательного примитива `"filter"`, который является объектом и может содержать:
1. Простой фильтр;
2. Дерево фильтров которое содержит простые фильтры с условиями.

Простой фильтр - это объект, который содержит в себе обязательные примитивы:
* `field` - поле сущности к которой будет применяться фильтрация (список заранее определён для метода);
* `operator` - оператор фильтрации. В таблице 6 представлен список всех операторов фильтрации;
* `value` - значение для оператора фильтрации. Необязательное поле, если оно отсутствует, то считается пустота.

Дерево фильтров содержит специальный примитив `"filters"`, который может содержать в себе как простые фильтры, так и дерево фильтров.

> Список полей, которые перечисляются в поле `field` определяются для каждого метода индивидуально. Поля, к которым могут применяться фильтры должны иметь индексы в БД.

### Возможные ошибки при фильтрации

Текст | Код | Мнемоника | Описание
----- | --- | --------- | --------
*Filter by parameter is prohibited* | `-32602` | `filter_prohibited` | Фильтрация по параметру запрещена и невозможна, так как параметр для фильтрации не находится в списке разрешенных для фильтрации
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Передан ошибочный параметр или параметр, которого не существует

### Пример JSON структуры простого фильтра

Получаем список записей у которых поле `"name"` имеет имя `"Bob"`

```json
{
  "jsonrpc":"2.0",
  "id":1,
  "method":"get.entity",
  "params":{
    "filter":{
      "field":"name",
      "operator":"eq",
      "value":"Bob"
    }
  }
}
```

### Пример JSON структуры дерева фильтров с одним уровнем вложенности

Получаем список записей у которых поле `"name"` имеет имя `"Bob"` и его возраст 25 лет

```json
{
  "jsonrpc":"2.0",
  "id":1,
  "method":"get.entity",
  "params":{
    "filter":{
      "filters":[
        {
          "field":"name",
          "operator":"eq",
          "value":"Bob"
        },
        {
          "field":"age",
          "operator":"eq",
          "value":25
        }
      ],
      "condition":"and"
    }
  }
}
```

### Пример JSON структуры дерева фильтров с двойным уровнем вложенности

Получаем список записей у которых поле `"name"` имеет имя `"Bob"` и его возраст 25 лет или список записей у которых поле `"name"` имеет имя `"Dexter"` и его возраст 2 года

```json
{
  "jsonrpc":"2.0",
  "id":1,
  "method":"get.entity",
  "params":{
    "filter":{
      "filters":[
        {
          "filters":[
            {
              "field":"name",
              "operator":"eq",
              "value":"Bob"
            },
            {
              "field":"age",
              "operator":"eq",
              "value":25
            }
          ],
          "condition":"and"
        },
        {
          "filters":[
            {
              "field":"name",
              "operator":"eq",
              "value":"Dexter"
            },
            {
              "field":"age",
              "operator":"eq",
              "value":2
            }
          ],
          "condition":"and"
        }
      ],
      "condition":"or"
    }
  }
}
```

### Пример JSON структуры дерева фильтров с тройным уровнем вложенности

Условие запроса `((addv_comp_id = 10 or addv_comp_id = 12) and (tag_id = 1 or tag_id = 5)) or visitor_id = 14 or (date_from = 2015-12-14 and date_till = 2015-12-16)`

```json
{
  "filter":{
    "filters":[
      {
        "filters":[
          {
            "filters":[
              {
                "field":"addv_comp_id",
                "operator":"eq",
                "value":10
              },
              {
                "field":"addv_comp_id",
                "operator":"eq",
                "value":12
              }
            ],
            "condition":"or"
          },
          {
            "filters":[
              {
                "field":"tag_id",
                "operator":"eq",
                "value":1
              },
              {
                "field":"tag_id",
                "operator":"eq",
                "value":5
              }
            ],
            "condition":"or"
          }
        ],
        "condition":"and"
      },
      {
        "field":"visitor_id",
        "value":14,
        "operator":"eq"
      },
      {
        "filters":[
          {
            "field":"date_from",
            "value":"2015-12-14",
            "operator":"eq"
          },
          {
            "field":"date_till",
            "value":"2015-12-16",
            "operator":"eq"
          }
        ],
        "condition":"and"
      }
    ],
    "condition":"or"
  }
}
```

### Операторы фильтрации

> Формат для дат  
> Для дат договорились, что будет формат iso8601

> Фильтрация null и not null  
> Фильтрация будет =null, !=null 

Оператор | Описание | Учёт регистра строк | Тип данных
-------- | -------- | ------------------- | ----------
`=` | Равно | да | number, string, null, boolean, iso8601, enum
`!=` | Не равно | да | number, string, null, boolean, iso8601, enum
`<` | Меньше чем | - | number, iso8601
`>` | Больше чем | - | number, iso8601
`<=` | Меньше или равно | - | number, iso8601
`>=` | Больше или равно | - | number, iso8601
`like` | Начинается с, Заканчивается на, Содержит | да | string
`regexp` | Posix | да | string
`jsquery` | PostgreSQL jsquery | да | object, array
`in` | Массив значений в отношении "or" | да | number, string, enum

## Сортировка данных

Сортировка данных применяется только к глаголу `"get"` (см. раздел [Глаголы используемые в именовании методов](#)) с помощью массива объектов сортировки со следующими примитивами:
* `field` - поле по которому производится сортировка;
* `order` - направления сортировки. Возможные значения `"asc"`/`"desc"`. `"asc"` - по возрастанию, `"desc"` - по убыванию.  
Параметр необязателен. Значение по умолчанию `"asс"`.

> Список полей по которым можно производить сортировку определяется индивидуально для каждого метода.

### Возможные ошибки при сортировки

Текст ошибки | Код | Мнемоника | Описание
------------ | --- | --------- | --------
*Sort by parameter is prohibited* | `-32602` | `sort_prohibited` | Сортировка по параметру запрещена и невозможна, так как параметр для сортировки не находится в списке разрешенных для сортировки
*Unexpected method parameter(s)* | `-32602` | `unexpected_parameters` | Передан ошибочный параметр или параметр, которого не существует

JSON структура:

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "sort":[
      {
        "field":"string",
        "order":"string"
      }
    ]
  }
}
```

## Постраничный вывод

Постраничный вывод может быть применён к глаголу `"get"` (см. раздел [Глаголы используемые в именовании методов](#)). Для выполнения пагинации данных используются следующие параметры:

Параметр | Значение по умолчанию | Допустимое значение | Описание
--- | --- | --- | ---
`offset` | 0 | 100 000 | сдвиг, определяет с какого номера записи возвращать `"limit"` записей
`limit` | 1000 | 10 000 | размер возвращаемых данных (количество записей)

JSON структура:

```json
{
  "jsonrpc":"2.0",
  "id":"number",
  "method":"string",
  "params":{
    "offset":"number",
    "limit":"number"
  }
}
```

## Мета-параметры

Возвращаются при использовании глагола `"get"` (см. раздел [Глаголы используемые в именовании методов](#)).

> Присутствуют как в ошибочном, так и в успешном ответе

> Параметр `"api_version"` возвращается только для версий которые deprecated.

JSON структура:

```json
{
  "metadata":{
    "api_version":{
      "current_version_deprecated":"boolean",
      "current_version":"string",
      "latest_version":"string"
    },
    "limits":{
      "day_limit":"number",
      "day_remaining":"number",
      "day_reset":"number",
      "minute_limit":"number",
      "minute_remaining":"number",
      "minute_reset":"number"
    },
    "total_items":"number"
  }
}
```

## Представление возвращаемых данных